{% extends "core/base.html" %}
{% load static %}

{% block title %}Payments - Loan App{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary: #28485d;
        --secondary: #d45d30;
        --text: #1d1d1f;
        --text-light: #6a6a6a;
        --border: #e5e7eb;
        --background: #f9fafb;
        --success: #10b981;
        --danger: #ef4444;
        --info: #3b82f6;
        --warning: #f59e0b;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                   0 2px 4px -2px rgba(0, 0, 0, 0.06);
        --border-radius: 0.5rem;
    }

    .main-content {
        padding: 16px;
        padding-top: 80px;
        /* This is the key fix */
        padding-bottom: 96px; 
    }

    .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: var(--primary);
        color: #fff;
        padding: 16px;
        text-align: center;
        font-weight: bold;
        box-shadow: var(--shadow);
        z-index: 50;
    }

    .search-box {
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 0 12px;
    }

    .search-box i {
        color: var(--text-light);
        margin-right: 12px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 0;
        border: none;
        background: transparent;
        font-size: 1rem;
        color: var(--text);
        outline: none;
    }

    .payments-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .payment-card {
        background: #fff;
        padding: 16px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .payment-card-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    }

    .payment-card-label {
        color: var(--text-light);
        font-weight: 500;
    }

    .payment-card-value {
        font-weight: 600;
        text-align: right;
    }

    .status-paid,
    .status-pending {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-paid {
        background: #d1fae5;
        color: var(--success);
    }

    .status-pending {
        background: #fef3c7;
        color: var(--warning);
    }

    .receipt-btn {
        padding: 6px 12px;
        border: none;
        background: var(--info);
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        transition: background-color 0.2s ease;
    }

    .receipt-btn:hover {
        background-color: #2563eb;
    }

    .nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        padding: 0.75rem 0;
        z-index: 40;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .nav-items {
        display: flex;
        justify-content: space-around;
    }
    
    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-light);
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        text-decoration: none;
    }
    
    .nav-item i {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }
    
    .nav-item.active {
        color: var(--primary);
    }

    /* Message styles */
    .message-container {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        width: calc(100% - 2rem);
        max-width: 500px;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        color: white;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .message-container.show {
        opacity: 1;
        visibility: visible;
    }

    .message-container.success {
        background-color: var(--success);
    }

    .message-container.error {
        background-color: var(--danger);
    }

    .message-container i {
        margin-right: 8px;
        font-size: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<header class="header">
    Payment History
</header>
<div id="successMessage" class="message-container success"></div>
<div id="errorMessage" class="message-container error"></div>

<div class="main-content">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search by agent, customer, or amount...">
    </div>
    <div id="paymentsList" class="payments-list"></div>
</div>

<nav class="nav">
    <div class="nav-items">
        <a href="{% url 'staff_dashboard' %}" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="{% url 'staff_userManagement' %}" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Users</span>
        </a>
        <a href="{% url 'payments' %}" class="nav-item active">
            <i class="fas fa-money-bill-wave"></i>
            <span>Payments</span>
        </a>
        <a href="{% url 'staff_reports' %}" class="nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Reports</span>
        </a>
        <a href="{% url 'staff_settings' %}" class="nav-item">
            <i class="fas fa-user-cog"></i>
            <span>Settings</span>
        </a>
    </div>
</nav>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    const API_PAYMENTS = "http://127.0.0.1:8000/api/payments/";

    function showMessage(type, message) {
        const msgElement = type === 'success' ? document.getElementById('successMessage') : document.getElementById('errorMessage');
        const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        msgElement.innerHTML = `<i class="${iconClass}"></i> ${message}`;
        msgElement.classList.add('show');
        setTimeout(() => {
            msgElement.classList.remove('show');
        }, 3000);
    }

async function loadPayments() {
    try {
        const res = await fetch(API_PAYMENTS);
        if (!res.ok) {
            throw new Error('Failed to fetch payment data');
        }
        const result = await res.json();   // result = { message: "...", data: [...] }
        const payments = result.data || []; // always fallback to []

        const paymentsList = document.getElementById("paymentsList");
        paymentsList.innerHTML = "";

        if (payments.length === 0) {
             paymentsList.innerHTML = `
                <p style="text-align: center; color: var(--text-light); margin-top: 2rem;">
                    No payments found.
                </p>
             `;
             return;
        }

        payments.forEach(p => {
            const card = document.createElement("div");
            card.classList.add("payment-card");

            let paidOnHtml = '';
            if (p.paid_on) {
                paidOnHtml = `
                    <div class="payment-card-row">
                        <span class="payment-card-label">Paid On:</span>
                        <span class="payment-card-value">${p.paid_on}</span>
                    </div>
                    <button class="receipt-btn" onclick='downloadReceipt(${JSON.stringify(p)})'>
                        <i class="fas fa-file-pdf"></i> Download Receipt
                    </button>
                `;
            } else {
                paidOnHtml = `
                    <div class="payment-card-row">
                        <span class="payment-card-label">Paid On:</span>
                        <span class="payment-card-value">-</span>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="payment-card-row">
                    <span class="payment-card-label">Agent:</span>
                    <span class="payment-card-value">${p.agent_name || 'N/A'}</span>
                </div>
                <div class="payment-card-row">
                    <span class="payment-card-label">Customer:</span>
                    <span class="payment-card-value">${p.customer_name || 'N/A'}</span>
                </div>
                <div class="payment-card-row">
                    <span class="payment-card-label">Amount Paid:</span>
                    <span class="payment-card-value">â‚¹${p.amt_paid}</span>
                </div>
                <div class="payment-card-row">
                    <span class="payment-card-label">Due Date:</span>
                    <span class="payment-card-value">${p.due_date || '-'}</span>
                </div>
                <div class="payment-card-row">
                    <span class="payment-card-label">Status:</span>
                    <span class="payment-card-value">
                        ${p.paid_on
                            ? `<span class="status-paid">Paid</span>`
                            : `<span class="status-pending">Not Paid</span>`}
                    </span>
                </div>
                ${paidOnHtml}
            `;
            paymentsList.appendChild(card);
        });
    } catch (error) {
        console.error("Failed to load payments", error);
        document.getElementById("paymentsList").innerHTML =
            `<p style="text-align: center; color: var(--text-light);">
                Failed to load payment data. Please try again.
             </p>`;
    }
}

    function downloadReceipt(p) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const logo = new Image();
            logo.src = "/static/icons/icon.png";

            logo.onload = () => {
                doc.addImage(logo, "PNG", 20, 10, 40, 20);
                
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("Payment Receipt", 105, 25, { align: "center" });

                doc.setDrawColor(200, 200, 200);
                doc.line(20, 35, 190, 35);

                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                let y = 50;
                const gap = 10;

                doc.text(`Receipt ID: ${p.payment_id || "-"}`, 20, y); y += gap;
                doc.text(`Agent: ${p.agent_name || "N/A"}`, 20, y); y += gap;
                doc.text(`Customer: ${p.customer_name || "N/A"}`, 20, y); y += gap;
                doc.text(`Amount Paid: â‚¹${p.amt_paid}`, 20, y); y += gap;
                doc.text(`Due Date: ${p.due_date || "-"}`, 20, y); y += gap;
                doc.text(`Status: ${p.paid_on ? "Paid" : "Not Paid"}`, 20, y); y += gap;
                doc.text(`Paid On: ${p.paid_on || "-"}`, 20, y);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Thank you for your payment!", 105, 280, { align: "center" });
                doc.text("Company Name - Confidential", 105, 287, { align: "center" });

                doc.save(`receipt_${p.payment_id || "payment"}.pdf`);
                showMessage('success', 'PDF receipt downloaded!');
            };

            logo.onerror = () => {
                showMessage('error', 'Failed to load logo for PDF. Please try again.');
            };

        } catch (error) {
            console.error("Failed to generate PDF", error);
            showMessage('error', 'An error occurred while generating the PDF.');
        }
    }

    document.getElementById("searchInput").addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        document.querySelectorAll(".payment-card").forEach(card => {
            card.style.display = card.textContent.toLowerCase().includes(filter) ? "flex" : "none";
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        // Show a loading message
        document.getElementById("paymentsList").innerHTML =
            `<p style="text-align: center; color: var(--text-light); margin-top: 2rem;">Loading payments...</p>`;
        loadPayments();
    });
</script>
{% endblock %}