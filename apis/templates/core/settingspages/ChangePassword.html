{% extends "core/base.html" %}

{% block title %}Login - Loan App{% endblock %}

{% block extra_head %}
<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background-color: var(--primary);
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .header-title {
    font-size: 20px;
    font-weight: 600;
    text-align: center;
    flex: 1; /* keeps centered */
  }

  .main-content {
    max-width: 600px;
    margin: 90px auto 100px auto;
    padding: 0 16px;
  }

  .form-group {
    margin-bottom: 20px;
    position: relative;
  }

  .form-label {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
    display: block;
  }

  .form-input {
    width: 100%;
    padding: 12px 45px 12px 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .form-input.invalid {
    border-color: var(--error);
  }

  .password-toggle {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-10%);
    color: var(--text-light);
    cursor: pointer;
  }

  .error-message {
    color: var(--error);
    font-size: 12px;
    margin-top: 4px;
    display: none;
  }

  .btn {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    max-width: 500px;
    width: calc(100% - 40px);
    padding: 14px 24px;
    background-color: var(--primary);
    color: white;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    text-align: center;
    border: none;
  }

  /* Message styles */
  .message-container {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    width: calc(100% - 2rem);
    max-width: 500px;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    color: white;
    text-align: center;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .message-container.show {
    opacity: 1;
    visibility: visible;
  }

  .message-container.success {
    background-color: var(--success);
  }

  .message-container.error {
    background-color: var(--error);
  }

  .message-container i {
    margin-right: 8px;
    font-size: 1rem;
  }

  /* Updated CSS for focus effect */
  .form-input:focus {
    outline: none;
    border-color: var(--primary-light);
    box-shadow: 0 0 0 3px rgba(212, 93, 48, 0.2); /* Using a slightly higher alpha for better visibility */
  }
</style>

<header class="header">
  <a href="{% url 'settings' %}" class="header-action">
    <i class="fas fa-chevron-left"></i>
  </a>
  <div class="header-title">Change Password</div>
  <div class="header-action"></div>
</header>

<div id="successMessage" class="message-container success"></div>
<div id="errorMessage" class="message-container error"></div>

<main class="main-content">
  <form id="changePasswordForm" method="POST" action="{% url 'change_password' %}" onsubmit="return handleFormSubmission(event)">
    {% csrf_token %}
    <div class="form-group">
      <label class="form-label" for="oldPassword">Old Password</label>
      <input type="password" class="form-input" name="oldPassword" id="oldPassword" placeholder="Enter current password" required>
      <i class="fas fa-eye password-toggle" onclick="togglePassword('oldPassword', this)"></i>
      <span class="error-message" id="oldPasswordError"></span>
    </div>

    <div class="form-group">
      <label class="form-label" for="newPassword">New Password</label>
      <input type="password" class="form-input" name="newPassword" id="newPassword" placeholder="Enter new password" required>
      <i class="fas fa-eye password-toggle" onclick="togglePassword('newPassword', this)"></i>
      <span class="error-message" id="newPasswordError"></span>
    </div>

    <div class="form-group">
      <label class="form-label" for="confirmPassword">Confirm New Password</label>
      <input type="password" class="form-input" name="confirmPassword" id="confirmPassword" placeholder="Confirm new password" required>
      <i class="fas fa-eye password-toggle" onclick="togglePassword('confirmPassword', this)"></i>
      <span class="error-message" id="confirmPasswordError"></span>
    </div>

    <button type="submit" class="btn">UPDATE PASSWORD</button>
  </form>
</main>

<script>
  function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input.type === "password") {
      input.type = "text";
      icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
      input.type = "password";
      icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
  }

  function showMessage(type, message) {
    const msgElement = type === 'success' ? document.getElementById('successMessage') : document.getElementById('errorMessage');
    const iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    msgElement.innerHTML = `<i class="${iconClass}"></i> ${message}`;
    msgElement.classList.add('show');
    setTimeout(() => {
      msgElement.classList.remove('show');
    }, 3000);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function validateForm() {
    let isValid = true;
    const inputs = [
      { id: 'oldPassword', errorId: 'oldPasswordError', message: 'Old password is required.' },
      { id: 'newPassword', errorId: 'newPasswordError', message: 'New password is required.' },
      { id: 'confirmPassword', errorId: 'confirmPasswordError', message: 'Please confirm your new password.' }
    ];

    inputs.forEach(item => {
      const input = document.getElementById(item.id);
      const errorEl = document.getElementById(item.errorId);
      errorEl.style.display = 'none';
      input.classList.remove('invalid');

      if (input.value.trim() === '') {
        input.classList.add('invalid');
        errorEl.textContent = item.message;
        errorEl.style.display = 'block';
        isValid = false;
      }
    });

    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const newError = document.getElementById('newPasswordError');
    const confirmError = document.getElementById('confirmPasswordError');

    if (newPassword.value.length > 0 && newPassword.value.length < 8) {
      newPassword.classList.add('invalid');
      newError.textContent = 'New password must be at least 8 characters.';
      newError.style.display = 'block';
      isValid = false;
    }

    if (newPassword.value !== confirmPassword.value && confirmPassword.value.length > 0) {
      confirmPassword.classList.add('invalid');
      confirmError.textContent = 'Passwords do not match.';
      confirmError.style.display = 'block';
      isValid = false;
    }

    return isValid;
  }

  async function handleFormSubmission(event) {
    event.preventDefault();

    if (!validateForm()) {
      return;
    }

    const form = document.getElementById('changePasswordForm');
    const formData = new FormData(form);

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      });

      const data = await response.json();

      if (response.ok) {
        showMessage('success', 'Password changed successfully!');
        form.reset();
      } else {
        showMessage('error', data.error || data.message || 'Failed to change password.');
      }
    } catch (error) {
      console.error('Submission error:', error);
      showMessage('error', 'Network error. Please try again.');
    }
  }
</script>
{% endblock %}