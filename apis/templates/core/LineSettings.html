{% extends "core/base.html" %}

{% block title %}Login - Loan App{% endblock %}

{% block extra_head %}

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    padding: 16px 20px;
    background-color: var(--primary);
    color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .header-action {
    color: white;
    text-decoration: none;
    font-size: 20px;
  }

  .header-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-size: 20px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .line-list {
    margin: 0;
    padding: 1rem;
    margin-top: 70px;
  }

  /* Card Styles */
  .line-card {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .line-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: none;
  }

  .line-name {
    font-weight: 600;
    color: #111827;
    flex: 1;
  }

  .delete-btn {
    color: #ef4444;
    background: none;
    border: none;
    padding: 8px;
    margin-left: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .delete-btn:hover {
    opacity: 0.7;
  }

  .delete-btn:active {
    opacity: 0.5;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #6b7280;
    margin-top: 4rem;
  }

  .empty-state i {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #4b5563;
  }

  .empty-state p {
    font-size: 1rem;
  }

  /* Message styles */
  .message-container {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    width: calc(100% - 2rem);
    max-width: 500px;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    color: white;
    text-align: center;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .message-container.show {
    opacity: 1;
    visibility: visible;
  }

  .message-container.success {
    background-color: #10b981;
  }

  .message-container.error {
    background-color: #ef4444;
  }

  .message-container i {
    margin-right: 8px;
    font-size: 1rem;
  }

  /* Custom Pop-up for Delete Confirmation */
  .delete-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 200;
  }

  .delete-modal {
    background: white;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    max-width: 350px;
    width: 90%;
    text-align: center;
    animation: fadeIn 0.3s ease-out;
  }

  .delete-modal p {
    margin-bottom: 24px;
    font-size: 16px;
    color: #4b5563;
  }

  .modal-actions {
    display: flex;
    justify-content: space-around;
  }

  .modal-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  #cancelDelete {
    background-color: #e5e7eb;
    color: #4b5563;
  }

  #confirmDelete {
    background-color: #ef4444;
    color: white;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }

    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<header class="header">
  <a href="{% url 'settings' %}" class="mr-4 text-white z-10">
    <i class="fas fa-chevron-left"></i>
  </a>
  <h1 class="text-xl font-semibold header-title">Line Settings</h1>
  <a href="{% url 'line_add_collection' %}" class="ml-auto text-white z-10">
    <i class="fas fa-plus"></i>
  </a>
</header>

<div id="successMessage" class="message-container success"></div>
<div id="errorMessage" class="message-container error"></div>

<div id="deleteModalOverlay" class="delete-modal-overlay">
  <div class="delete-modal">
    <h3 class="text-lg font-semibold mb-4">Confirm Deletion</h3>
    <p>Are you sure you want to delete <span id="lineNameToDelete" class="font-bold"></span>?</p>
    <div class="modal-actions">
      <button id="cancelDelete">Cancel</button>
      <button id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<main>
  <div id="lineList" class="line-list">
    {% for line in lines %}
    <div class="line-card">
      <div class="line-item">
        <div class="line-name">{{ line.line_name }}</div>
        <button class="delete-btn" data-id="{{ line.id }}" data-name="{{ line.line_name }}">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
    {% empty %}
    <div class="empty-state">
      <i class="fas fa-layer-group"></i>
      <h3>No Lines Found</h3>
      <p>Add your first line to get started</p>
    </div>
    {% endfor %}
  </div>
</main>

<script>
  const successMessage = document.getElementById('successMessage');
  const errorMessage = document.getElementById('errorMessage');

  const deleteModalOverlay = document.getElementById('deleteModalOverlay');
  const lineNameToDelete = document.getElementById('lineNameToDelete');
  const confirmDeleteBtn = document.getElementById('confirmDelete');
  const cancelDeleteBtn = document.getElementById('cancelDelete');

  function showMessage(type, message) {
    const msgElement = type === 'success' ? successMessage : errorMessage;
    msgElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
    msgElement.classList.add('show');
    setTimeout(() => {
      msgElement.classList.remove('show');
    }, 3000);
  }

  function showDeleteConfirmation(lineId, lineName) {
    return new Promise((resolve) => {
      lineNameToDelete.textContent = `"${lineName}"`;
      deleteModalOverlay.style.display = 'flex';

      const handleConfirm = () => {
        deleteModalOverlay.style.display = 'none';
        confirmDeleteBtn.removeEventListener('click', handleConfirm);
        cancelDeleteBtn.removeEventListener('click', handleCancel);
        resolve(true);
      };

      const handleCancel = () => {
        deleteModalOverlay.style.display = 'none';
        confirmDeleteBtn.removeEventListener('click', handleConfirm);
        cancelDeleteBtn.removeEventListener('click', handleCancel);
        resolve(false);
      };

      confirmDeleteBtn.addEventListener('click', handleConfirm);
      cancelDeleteBtn.addEventListener('click', handleCancel);
    });
  }

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget;
      const lineId = button.dataset.id;
      const lineName = button.dataset.name;
      const lineItem = button.closest('.line-card');

      const confirmed = await showDeleteConfirmation(lineId, lineName);

      if (confirmed) {
        try {
          const response = await fetch(`/api/lines/${lineId}/`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            }
          });

          if (response.ok) {
            lineItem.remove();
            showMessage('success', `Line "${lineName}" deleted.`);
            if (document.querySelectorAll('.line-card').length === 0) {
              const emptyState = document.createElement('div');
              emptyState.className = 'empty-state';
              emptyState.innerHTML = `<i class="fas fa-layer-group"></i>
                  <h3>No Lines Found</h3>
                  <p>Add your first line to get started</p>`;
              document.getElementById('lineList').appendChild(emptyState);
            }
          } else {
            showMessage('error', `Failed to delete line: "${lineName}".`);
          }
        } catch (error) {
          console.error('Error deleting line:', error);
          showMessage('error', 'An error occurred while deleting the line.');
        }
      }
    });
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}